<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BNI 雲貴資源配對系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --bni-red: #CF102D; 
            --bni-dark-red: #8B0000; 
            --gold: #B3995D; 
        }
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f8fafc; height: 100vh; display: flex; flex-direction: column; }
        
        /* 參考程式碼的彈窗樣式 */
        #loginOverlay, #adminOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:flex; justify-content:center; align-items:center; z-index:4000; backdrop-filter: blur(5px); }
        .confirm-box { background: white; width:90%; max-width:320px; border-radius:15px; overflow:hidden; text-align:center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .box-header { background: linear-gradient(135deg, var(--bni-red), var(--bni-dark-red)); color:white; padding:15px; font-weight:bold; font-size: 18px; border-bottom: 3px solid var(--gold); }
        
        /* 九宮格樣式 */
        .grid-box { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 2px; background: #cbd5e1; border-radius: 4px; aspect-ratio: 1; }
        .cell { background: white; display: flex; align-items: center; justify-content: center; position: relative; }
        .cell textarea { width: 100%; height: 100%; text-align: center; resize: none; font-size: 11px; padding: 4px; outline: none; border: none; background: transparent; line-height: 1.3; }
        .center-cell { background-color: var(--bni-red); }
        .center-cell textarea { color: white; font-weight: bold; font-size: 14px; }
        
        /* 按鈕樣式 (參考) */
        .btn-bni { background: var(--bni-red); color: white; border: none; padding: 10px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-bni:active { transform: scale(0.98); background: var(--bni-dark-red); }

        /* 隱藏區塊動畫 */
        .tab-content { display: none; animation: fadeIn 0.3s; height: 100%; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="confirm-box">
            <div class="box-header"><i class="fa-solid fa-user-check mr-2"></i>夥伴識別</div>
            <div style="padding:25px;">
                <p class="text-sm text-gray-500 mb-2">請輸入您的真實姓名</p>
                <input type="text" id="userNameInput" placeholder="例如：吳志璘" class="w-full p-3 border border-gray-300 rounded text-center text-lg font-bold focus:border-red-600 focus:outline-none">
            </div>
            <div style="display:flex; border-top:1px solid #eee;">
                <button onclick="app.handleLogin()" class="flex-1 p-4 font-bold text-[#CF102D] hover:bg-gray-50">進入系統</button>
            </div>
        </div>
    </div>

    <div id="adminOverlay" style="display:none;">
        <div class="confirm-box">
            <div class="box-header" style="background:#333;"><i class="fa-solid fa-lock mr-2"></i>幹部權限</div>
            <div style="padding:25px;">
                <input type="password" id="adminPwd" placeholder="輸入管理密碼" class="w-full p-3 border border-gray-300 rounded text-center">
            </div>
            <div style="display:flex; border-top:1px solid #eee;">
                <button onclick="document.getElementById('adminOverlay').style.display='none'" class="flex-1 p-4 text-gray-500">取消</button>
                <button onclick="app.checkAdmin()" class="flex-1 p-4 font-bold text-[#CF102D]">驗證</button>
            </div>
        </div>
    </div>

    <header class="bg-white shadow z-20 px-4 py-3 flex justify-between items-center border-b-2 border-[#B3995D]">
        <div class="flex items-center gap-2">
            <div class="text-[#CF102D] text-2xl"><i class="fa-solid fa-network-wired"></i></div>
            <div>
                <h1 class="font-bold text-gray-800 leading-tight">雲貴資源配對</h1>
                <p id="currentUserDisplay" class="text-[10px] text-gray-500">訪客</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="app.switchTab('grid')" id="btn-grid" class="px-3 py-1.5 text-xs font-bold rounded bg-[#CF102D] text-white shadow">需求</button>
            <button onclick="app.switchTab('resources')" id="btn-resources" class="px-3 py-1.5 text-xs font-bold rounded text-gray-600 hover:bg-gray-100">資源</button>
            <button onclick="app.switchTab('match')" id="btn-match" class="px-3 py-1.5 text-xs font-bold rounded text-gray-600 hover:bg-gray-100">配對</button>
            <button onclick="document.getElementById('adminOverlay').style.display='flex'" class="text-gray-300 hover:text-red-600 px-2"><i class="fa-solid fa-gear"></i></button>
        </div>
    </header>

    <main class="flex-1 overflow-hidden bg-gray-50 relative w-full max-w-5xl mx-auto p-2">
        
        <div id="tab-grid" class="tab-content active h-full overflow-y-auto pb-20">
            <div class="bg-white p-3 rounded-lg shadow mb-3 border-l-4 border-[#CF102D]">
                <h2 class="font-bold text-gray-800">1. 規劃您的需求</h2>
                <p class="text-xs text-gray-500">填寫您需要的「產業關鍵字」，系統將自動比對全分會資源。</p>
            </div>
            <div id="mandala-container" class="grid grid-cols-3 gap-1 md:gap-2 aspect-square max-h-[80vh] mx-auto"></div>
        </div>

        <div id="tab-resources" class="tab-content h-full overflow-y-auto pb-20">
            <div class="bg-white p-4 rounded-lg shadow mb-3">
                <h2 class="font-bold text-gray-800 mb-2">2. 建立人脈變現表</h2>
                <div class="flex gap-2 mb-2">
                    <input id="res-name" class="border p-2 rounded w-1/3 text-sm" placeholder="姓名">
                    <input id="res-ind" class="border p-2 rounded w-1/3 text-sm" placeholder="產業 (配對關鍵)">
                    <select id="res-grade" class="border p-2 rounded w-1/3 text-sm"><option value="A">A級</option><option value="B">B級</option><option value="C">C級</option></select>
                </div>
                <button onclick="app.addResource()" class="btn-bni"><i class="fa-solid fa-plus mr-1"></i> 新增資源</button>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-700 font-bold">
                        <tr><th class="p-3">等級</th><th class="p-3">姓名/產業</th><th class="p-3 text-right">操作</th></tr>
                    </thead>
                    <tbody id="resource-list" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-match" class="tab-content h-full overflow-y-auto pb-20">
            <div class="flex justify-between items-center mb-4 bg-gray-800 text-white p-4 rounded-lg shadow">
                <div>
                    <h2 class="font-bold text-lg">智能配對報告</h2>
                    <p class="text-xs text-gray-400">您的81宮格 vs 全體夥伴資源庫</p>
                </div>
                <button onclick="app.runMatching()" class="bg-[#CF102D] hover:bg-red-700 px-4 py-2 rounded font-bold text-sm shadow">
                    <i class="fa-solid fa-rotate mr-1"></i>刷新
                </button>
            </div>
            <div id="match-results" class="space-y-3">
                <div class="text-center text-gray-400 py-10">點擊上方按鈕開始配對</div>
            </div>
        </div>

        <div id="tab-admin" class="tab-content h-full overflow-y-auto p-4 hidden">
            <div class="bg-red-50 border-2 border-red-200 p-4 rounded-lg text-center">
                <h2 class="text-xl font-bold text-red-800 mb-4">⚠️ 危險操作區</h2>
                <button onclick="app.clearAllData()" class="bg-red-600 text-white px-6 py-3 rounded-lg font-bold shadow hover:bg-red-700 w-full mb-2">
                    <i class="fa-solid fa-trash-can mr-2"></i>清空所有資料庫 (重置)
                </button>
                <p class="text-xs text-red-500">此操作無法復原，請謹慎使用。</p>
            </div>
        </div>

    </main>

    <script>
        // 設定 Supabase
        const SUPABASE_URL = 'https://erqwwyuubhnhfrbuuflg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVycXd3eXV1YmhuaGZyYnV1ZmxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2ODg3MDcsImV4cCI6MjA4NjI2NDcwN30.13L7o3dKJiFPynEdyxzFLTWJbirRTzhnJ2DLKagw-YA';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const ADMIN_PWD = 'yungui666'; // 來自參考程式碼的密碼

        const app = {
            currentUser: null,
            gridData: {},
            contacts: [],

            init() {
                // 檢查是否有快取的使用者
                const savedUser = localStorage.getItem('bni_user');
                if (savedUser) {
                    app.currentUser = savedUser;
                    document.getElementById('userNameInput').value = savedUser;
                    app.handleLogin();
                } else {
                    document.getElementById('loginOverlay').style.display = 'flex';
                }
            },

            // 1. 登入邏輯 (參考風格)
            async handleLogin() {
                const name = document.getElementById('userNameInput').value.trim();
                if (!name) return alert('請輸入姓名');
                
                app.currentUser = name;
                localStorage.setItem('bni_user', name); // 記住使用者
                
                document.getElementById('currentUserDisplay').textContent = `會員：${name}`;
                document.getElementById('loginOverlay').style.display = 'none';

                // 載入資料
                await app.loadUserData();
            },

            // 2. 載入資料 (Upsert 模式：有就讀取，沒有就創建)
            async loadUserData() {
                // 讀取 Profile (81宮格)
                let { data: profile } = await supabase.from('profiles').select('*').eq('name', app.currentUser).single();
                
                if (!profile) {
                    // 如果是新用戶，自動建立
                    await supabase.from('profiles').insert([{ name: app.currentUser, grid_data: {} }]);
                    app.gridData = {};
                } else {
                    app.gridData = profile.grid_data || {};
                }
                
                // 讀取 Contacts
                let { data: contacts } = await supabase.from('contacts').select('*').eq('owner_name', app.currentUser).order('created_at', {ascending: false});
                app.contacts = contacts || [];

                app.renderGrid();
                app.renderResources();
            },

            // 3. 渲染 81 宮格
            renderGrid() {
                const container = document.getElementById('mandala-container');
                let html = '';
                for(let b=0; b<9; b++) {
                    const isCore = (b === 4);
                    html += `<div class="grid-box ${isCore ? 'border-2 border-red-600' : ''}">`;
                    for(let c=0; c<9; c++) {
                        const isCenter = (c === 4);
                        const key = `${b}-${c}`;
                        const val = app.gridData[key] || '';
                        // 唯讀處理 (如果是週邊宮格的中心，應該唯讀並同步)
                        const isTopic = (b!==4 && c===4); 
                        
                        html += `<div class="cell ${isCenter ? 'center-cell' : ''} ${isTopic ? 'bg-gray-100' : ''}">
                            <textarea id="cell-${key}" 
                                placeholder="${isCenter ? '主題' : ''}" 
                                onchange="app.saveGrid('${key}', this.value)"
                                ${isTopic ? 'readonly' : ''}
                            >${val}</textarea>
                        </div>`;
                    }
                    html += `</div>`;
                }
                container.innerHTML = html;
            },

            async saveGrid(key, val) {
                app.gridData[key] = val;
                
                // 邏輯：修改中間大格(Block 4)的周圍格子 -> 同步到對應外圍大格的中心
                if(key.startsWith('4-') && !key.endsWith('-4')) {
                    const targetBlock = key.split('-')[1]; // 取得目標 Block ID
                    const targetKey = `${targetBlock}-4`; // 該 Block 的中心
                    app.gridData[targetKey] = val;
                    // 即時更新 UI
                    const el = document.getElementById(`cell-${targetKey}`);
                    if(el) el.value = val;
                }

                // 儲存到 DB
                await supabase.from('profiles').update({ grid_data: app.gridData }).eq('name', app.currentUser);
            },

            // 4. 資源庫邏輯
            async addResource() {
                const name = document.getElementById('res-name').value;
                const ind = document.getElementById('res-ind').value;
                const grade = document.getElementById('res-grade').value;
                if(!name || !ind) return alert('請填寫完整');

                const { data, error } = await supabase.from('contacts').insert([{
                    owner_name: app.currentUser, name, industry: ind, grade
                }]).select();

                if(!error) {
                    app.contacts.unshift(data[0]);
                    app.renderResources();
                    document.getElementById('res-name').value = '';
                    document.getElementById('res-ind').value = '';
                }
            },

            async deleteResource(id) {
                if(confirm('刪除此資源？')) {
                    await supabase.from('contacts').delete().eq('id', id);
                    app.contacts = app.contacts.filter(c => c.id !== id);
                    app.renderResources();
                }
            },

            renderResources() {
                const tbody = document.getElementById('resource-list');
                tbody.innerHTML = app.contacts.map(c => `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="p-3 font-bold ${c.grade==='A'?'text-green-600':'text-gray-500'}">${c.grade}</td>
                        <td class="p-3">
                            <div class="font-bold text-gray-800">${c.name}</div>
                            <div class="text-xs text-blue-600">${c.industry}</div>
                        </td>
                        <td class="p-3 text-right">
                            <button onclick="app.deleteResource('${c.id}')" class="text-gray-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            // 5. 配對邏輯 (核心)
            async runMatching() {
                const container = document.getElementById('match-results');
                container.innerHTML = '<div class="text-center py-10"><i class="fa-solid fa-spinner fa-spin text-2xl text-red-600"></i><br>搜尋中...</div>';

                // 收集需求
                const needs = new Set();
                for(let key in app.gridData) {
                    const val = app.gridData[key];
                    if(val && val.trim().length > 1 && !key.endsWith('-4')) needs.add(val.trim());
                }

                if(needs.size === 0) return container.innerHTML = '<div class="text-center text-gray-400 py-10">請先填寫 81 宮格需求</div>';

                // 撈全體資料
                const { data: allContacts } = await supabase.from('contacts').select('*');

                let html = '';
                needs.forEach(need => {
                    const matches = allContacts.filter(c => c.industry.includes(need) || need.includes(c.industry));
                    
                    if(matches.length > 0) {
                        html += `
                        <div class="bg-white p-3 rounded shadow border-l-4 border-green-500">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-gray-800">需求：${need}</span>
                                <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded">匹配 ${matches.length} 筆</span>
                            </div>
                            <div class="space-y-2">
                                ${matches.map(m => `
                                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded text-sm">
                                        <div>
                                            <span class="font-bold">${m.name}</span> <span class="text-xs text-gray-500">(${m.industry})</span>
                                            <div class="text-xs text-[#CF102D]"><i class="fa-solid fa-user mr-1"></i>資源提供：${m.owner_name}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                    } else {
                        html += `<div class="p-3 rounded border border-gray-200 flex justify-between opacity-60"><span class="text-sm">需求：${need}</span><span class="text-xs">尚無匹配</span></div>`;
                    }
                });

                container.innerHTML = html || '<div class="text-center py-10">尚無符合資料</div>';
            },

            // 6. 管理員邏輯
            checkAdmin() {
                const pwd = document.getElementById('adminPwd').value;
                if(pwd === ADMIN_PWD) {
                    document.getElementById('adminOverlay').style.display = 'none';
                    app.switchTab('admin'); // 進入隱藏頁面
                    document.getElementById('adminPwd').value = '';
                } else {
                    alert('密碼錯誤');
                }
            },

            async clearAllData() {
                if(confirm('⚠️ 這是毀滅性操作！確定要清空所有人的資料嗎？')) {
                    const check = prompt('請輸入「確認清空」');
                    if(check === '確認清空') {
                        await supabase.from('contacts').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                        await supabase.from('profiles').delete().neq('name', 'admin');
                        alert('已重置系統');
                        location.reload();
                    }
                }
            },

            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.getElementById('tab-' + tabId).classList.add('active');
                
                // 按鈕樣式
                ['grid', 'resources', 'match'].forEach(id => {
                    const btn = document.getElementById('btn-' + id);
                    if(btn) {
                        if(id === tabId) btn.className = "px-3 py-1.5 text-xs font-bold rounded bg-[#CF102D] text-white shadow transition";
                        else btn.className = "px-3 py-1.5 text-xs font-bold rounded text-gray-600 hover:bg-gray-100 transition";
                    }
                });
            }
        };

        window.onload = app.init;
    </script>
</body>
</html>
